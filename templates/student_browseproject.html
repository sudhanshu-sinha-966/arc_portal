<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Browse Projects | Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --sidebar-width: 250px;
      --primary: #1e3c72;
      --accent: #fbc2eb;
      --bg: #f6f8fa;
      --sidebar-bg: #232946;
      --sidebar-active: #fbc2eb22;
      --sidebar-hover: #fbc2eb11;
      --main-radius: 22px;
      --card-radius: 16px;
      --card-bg: #fff;
      --card-shadow: 0 2px 10px rgba(30, 60, 114, 0.07);
      --filter-bg: #fff;
    }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: #232946;
      height: 100vh;
      overflow: hidden;
    }
    .dashboard-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 32px 0 24px 0;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 100;
      box-shadow: 2px 0 16px 0 #0002;
    }
    .sidebar .sidebar-logo {
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: 1.2px;
      color: var(--accent);
      margin-bottom: 48px;
      text-align: center;
      user-select: none;
    }
    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 32px;
      font-size: 1.08rem;
      color: #fff;
      text-decoration: none;
      border-left: 4px solid transparent;
      border-radius: 0 18px 18px 0;
      transition: background 0.18s, border-color 0.2s, color 0.2s;
      cursor: pointer;
    }
    .sidebar-link.active,
    .sidebar-link:focus {
      background: var(--sidebar-active);
      border-left: 4px solid var(--accent);
      color: var(--accent);
      font-weight: 600;
    }
    .sidebar-link:hover:not(.active) {
      background: var(--sidebar-hover);
      color: var(--accent);
    }
    .sidebar-footer {
      margin-top: 48px;
      text-align: center;
      font-size: 0.95rem;
      color: #fff8;
      letter-spacing: 0.2px;
    }
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 38px 48px 32px 48px;
      width: calc(100vw - var(--sidebar-width));
      height: 100vh;
      overflow-y: auto;
      background: var(--bg);
      border-radius: var(--main-radius) 0 0 var(--main-radius);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 18px;
      letter-spacing: 1px;
    }
    .search-filter-bar {
      background: var(--filter-bg);
      border-radius: 14px;
      box-shadow: 0 2px 12px #1e3c7211;
      padding: 18px 24px 12px 24px;
      margin-bottom: 28px;
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
    }
    .search-input {
      flex: 2;
      min-width: 220px;
      font-size: 1.06rem;
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      background: #f6f8fa;
      color: #232946;
      transition: border 0.18s;
      font-family: inherit;
    }
    .search-input:focus {
      border-color: var(--accent);
      outline: none;
    }
    .filter-select {
      flex: 1;
      min-width: 140px;
      font-size: 1.06rem;
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      background: #f6f8fa;
      color: #232946;
      font-family: inherit;
    }
    .projects-list {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
    }
    .project-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      padding: 28px 26px 22px 26px;
      min-width: 270px;
      max-width: 340px;
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
      margin-bottom: 18px;
      position: relative;
      transition: box-shadow 0.2s, transform 0.2s;
      animation: fadeIn 0.7s;
    }
    .project-card:hover {
      box-shadow: 0 8px 28px #fbc2eb44;
      transform: translateY(-4px) scale(1.025);
    }
    .proj-title {
      font-size: 1.22rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 7px;
    }
    .proj-prof {
      font-size: 1.02rem;
      color: #232946b0;
      margin-bottom: 7px;
    }
    .proj-dept {
      font-size: 0.98rem;
      color: #1e3c72a0;
      margin-bottom: 7px;
    }
    .proj-topic {
      font-size: 1.01rem;
      color: #1e3c72c0;
      margin-bottom: 7px;
    }
    .proj-skills {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-bottom: 10px;
    }
    .proj-skill {
      background: #fbc2eb55;
      color: var(--primary);
      border-radius: 6px;
      padding: 0.19em 0.8em;
      font-size: 0.97rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .apply-btn {
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7em 1.6em;
      font-size: 1.09rem;
      font-weight: 700;
      letter-spacing: 1px;
      cursor: pointer;
      box-shadow: 0 2px 12px 0 #fbc2eb55;
      transition: background 0.2s, transform 0.12s;
      text-decoration: none;
      margin-top: 10px;
      outline: none;
      align-self: flex-end;
    }
    .apply-btn[disabled] {
      background: #e0e0e0;
      color: #23294699;
      cursor: not-allowed;
      box-shadow: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px);}
      to { opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 900px) {
      .dashboard-container { flex-direction: column; }
      .sidebar {
        width: 100vw;
        height: auto;
        position: relative;
        flex-direction: row;
        align-items: center;
        padding: 16px 0;
        box-shadow: none;
      }
      .sidebar .sidebar-logo {
        margin: 0 24px 0 24px;
      }
      .sidebar-nav {
        flex-direction: row;
        gap: 0;
      }
      .sidebar-link {
        padding: 8px 14px;
        border-radius: 12px;
        border-left: none;
        border-bottom: 3px solid transparent;
      }
      .sidebar-link.active,
      .sidebar-link:focus {
        border-left: none;
        border-bottom: 3px solid var(--accent);
        border-radius: 12px 12px 0 0;
      }
      .main-content {
        margin-left: 0;
        margin-top: 0;
        padding: 24px 10vw 24px 10vw;
        width: 100vw;
        border-radius: 0;
      }
      .projects-list { gap: 18px; }
    }
    @media (max-width: 600px) {
      .main-content {
        padding: 12px 4px 12px 4px;
      }
      .page-title { font-size: 1.2rem; }
      .project-card { padding: 12px 8px 10px 8px; min-width: 90vw; }
      .search-filter-bar { flex-direction: column; gap: 10px; padding: 10px 6px 10px 6px;}
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sidebar-logo">ARC Portal</div>
      <div class="sidebar-nav">
        <a class="sidebar-link" href="/dashboard/student">&#x1F4C8; Dashboard</a>
        <a class="sidebar-link active" href="/student/browse-projects">&#x1F4D1; Browse Projects</a>
        <a class="sidebar-link" href="/student/my-applications">&#x1F4E6; My Applications</a>
        <a class="sidebar-link" href="/profile/student">&#x1F464; Profile</a>
        <a class="sidebar-link" href="/logout" style="margin-top:20px;color:#fbc2eb;">&#x1F6AA; Logout</a>
      </div>
      <div class="sidebar-footer">
        &copy; 2025 Academic Research Collaboration
      </div>
    </nav>
    <!-- Main Content -->
    <!-- ...header/sidebar layout as before... -->

<main class="main-content">
  <div class="page-title">Browse All Research Projects</div>
  
  <!-- (You can upgrade filter dropdowns to use professor/department/topic lists from DB) -->
  <div class="search-filter-bar">
    <input type="text" id="searchInput" class="search-input" placeholder="Search by title, topic, professor, or skill...">
    <select id="filterProfessor" class="filter-select">
      <option value="">All Professors</option>
      {% for prof in professors %}
        <option value="{{ prof.name }}">{{ prof.name }}</option>
      {% endfor %}
    </select>
    <!-- Add similar dynamic dropdowns for topic/department if you want -->
  </div>

  <div class="projects-list">
    {% for project, professor in projects %}
      <div class="project-card">
        <div class="proj-title">{{ project.title }}</div>
        <div class="proj-prof">By {{ professor.name }}</div>
        <div class="proj-dept">{{ professor.department or "" }}</div>
        <div class="proj-topic">{{ project.objective or project.introduction or project.status }}</div>
        <div class="proj-skills">
          {% for skill in (project.required_skills or "").split(",") %}
            <span class="proj-skill">{{ skill.strip() }}</span>
          {% endfor %}
        </div>
        <!-- View and Apply Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button type="button" class="apply-btn view-btn" data-project-id="{{ project.id }}" style="background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%); flex: 1;">View Details</button>
          <form method="POST" action="/student/apply-project" style="margin:0; flex: 1;" class="apply-form" data-project-id="{{ project.id }}">
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <button type="submit" class="apply-btn" id="apply-btn-{{ project.id }}">Apply</button>
          </form>
        </div>
        <!-- Optionally: Show "Applied" or disable button if already applied (requires Application check) -->
      </div>
    {% else %}
      <div style='color:#1e3c72;font-size:1.2rem;margin-top:2em;'>No projects found.</div>
    {% endfor %}
  </div>
</main>

  </div>
  <!-- Project Details Modal -->
  <div id="projectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 16px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="modalTitle" style="color: var(--primary); margin: 0;">Project Details</h2>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <div id="modalContent">Loading...</div>
    </div>
  </div>

  <script>
    // Applied projects tracking
    let appliedProjects = new Set();
    
    // Load applied projects from session storage
    function loadAppliedProjects() {
      const stored = sessionStorage.getItem('appliedProjects');
      if (stored) {
        appliedProjects = new Set(JSON.parse(stored));
        updateApplyButtons();
      }
    }
    
    // Save applied projects to session storage
    function saveAppliedProjects() {
      sessionStorage.setItem('appliedProjects', JSON.stringify([...appliedProjects]));
    }
    
    // Update apply button states
    function updateApplyButtons() {
      appliedProjects.forEach(projectId => {
        const btn = document.getElementById(`apply-btn-${projectId}`);
        if (btn) {
          btn.textContent = 'Applied';
          btn.disabled = true;
          btn.style.background = '#e0e0e0';
          btn.style.color = '#666';
        }
      });
    }
    
    // View project details
    async function viewProject(projectId) {
      try {
        const response = await fetch(`/api/student/project/${projectId}`);
        if (response.ok) {
          const project = await response.json();
          document.getElementById('modalTitle').textContent = project.title;
          document.getElementById('modalContent').innerHTML = `
            <div style="margin-bottom: 15px;"><strong>Introduction:</strong><br>${project.introduction || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Problem Definition:</strong><br>${project.problem_definition || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Objective:</strong><br>${project.objective || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Methodology:</strong><br>${project.methodology || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Scope:</strong><br>${project.scope || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Timeline:</strong><br>${project.timeline || 'Not provided'}</div>
            <div style="margin-bottom: 15px;"><strong>Required Skills:</strong><br>${project.required_skills || 'Not specified'}</div>
            <div style="margin-bottom: 15px;"><strong>Status:</strong> ${project.status}</div>
            <div style="margin-bottom: 15px;"><strong>Last Updated:</strong> ${project.updated_at}</div>
          `;
          document.getElementById('projectModal').style.display = 'block';
        } else {
          alert('Failed to load project details');
        }
      } catch (error) {
        console.error('Error fetching project details:', error);
        alert('Error loading project details');
      }
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('projectModal').style.display = 'none';
    }
    
    // Handle apply button click
    function handleApply(event, projectId) {
      if (appliedProjects.has(projectId)) {
        event.preventDefault();
        alert('You have already applied to this project.');
        return false;
      }
      
      // Add to applied projects
      appliedProjects.add(projectId);
      saveAppliedProjects();
      
      // Update button immediately
      const btn = document.getElementById(`apply-btn-${projectId}`);
      if (btn) {
        btn.textContent = 'Applied';
        btn.disabled = true;
        btn.style.background = '#e0e0e0';
        btn.style.color = '#666';
      }
      
      return true;
    }
    
    // Filter functionality
    function filterProjects() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const professor = document.getElementById('filterProfessor').value;
      
      const cards = document.querySelectorAll('.project-card');
      cards.forEach(card => {
        const title = card.querySelector('.proj-title').textContent.toLowerCase();
        const prof = card.querySelector('.proj-prof').textContent.toLowerCase();
        const topic = card.querySelector('.proj-topic').textContent.toLowerCase();
        const skills = card.querySelector('.proj-skills').textContent.toLowerCase();
        
        const matchesSearch = !search || title.includes(search) || prof.includes(search) || topic.includes(search) || skills.includes(search);
        const matchesProf = !professor || prof.includes(professor.toLowerCase());
        
        card.style.display = (matchesSearch && matchesProf) ? 'flex' : 'none';
      });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadAppliedProjects();
      
      // Add event listeners
      document.getElementById('searchInput').addEventListener('input', filterProjects);
      document.getElementById('filterProfessor').addEventListener('change', filterProjects);
      
      // Add view button event listeners
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const projectId = this.getAttribute('data-project-id');
          viewProject(parseInt(projectId));
        });
      });
      
      // Add apply form event listeners
      document.querySelectorAll('.apply-form').forEach(form => {
        form.addEventListener('submit', function(event) {
          const projectId = parseInt(this.getAttribute('data-project-id'));
          return handleApply(event, projectId);
        });
      });
      
      // Close modal when clicking outside
      document.getElementById('projectModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>
